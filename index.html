<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- CSS -->
  <link href="css/jquery.mobile-1.4.2.min.css" rel="stylesheet">

  <!-- jQuery -->
  <script src="js/jquery/jquery-2.1.0.js"></script>
  <script src="js/jquery/jquery.mobile-1.4.2.min.js"></script>

  <!-- ROSLIBJS -->
  <!-- EventEmitter2 is the sole dependency of roslibjs -->
  <script src="js/ros/eventemitter2/eventemitter2.js"></script>
  <!-- Roslibjs handles core ROS functionality in the browser -->
  <script src="js/ros/roslibjs/roslib.js"></script>
  <!-- ROS2DJS -->
  <!-- EaselJS is a dependency of ros2djs -->
  <script src="js/ros/easeljs/easeljs.js"></script>
  <!-- Ros2djs provides 2D scene support, including mapping and more -->
  <script src="js/ros/ros2djs/ros2d.js"></script>

  <!-- ROS3DJS -->
  <!-- Three.js is the WebGL rendering library -->
  <script src="js/ros/three/three.js"></script>
  <!-- ColladaLoader2 loads collada models of the robot -->
  <script src="js/ros/STLLoader/STLLoader.min.js"></script>
  <!-- ColladaLoader loads collada models of the robot -->
	<script src="js/ros/ColladaLoader/ColladaLoader.js"></script>
  <!-- Ros3djs provides 3D scene support, including mapping and more -->
  <script src="js/ros/ros3djs/ros3d.js"></script>
  <!-- NAV2D -->
  <script src="js/ros/nav2djs/nav2d.js"></script>
  <!-- ROS console -->
  <script src="js/console/rosconsole.js"></script>

  <script>
    $(document).ready(function() {

      var heightHeader = $(this).find('[data-role="header"]').height();
      var widthPage = $(window).width() - 16 * 2;
      var heightPage = $(window).height() - heightHeader - 16 * 2 - 110;


      var runControl = function(json) {
        // Load default configuration
        json = json || {};
        // Load robot configuration parameters
        json.robot = (('robot' in json) ? json.robot : {});
        
        // Initialize Console
        var name_page = json.name_page || "ROS Web console";
        var connection = json.server || 'localhost';
        
        var ros = new ROSCONSOLE.controller({
          addr: connection,
          fixed_frame: json.robot.fixed_frame,
        });

        var windowController = new ROSCONSOLE.WindowController(name_page);
        
        var map3D = new ROSCONSOLE.ROS3Dmap({
          ros: ros.ros,
          tfClient: ros.tfClient,
          divID: 'threed-map',
          width: widthPage,
          height: heightPage,
          path: json.path_mesh || 'localhost',
          param: json.robot.description || 'robot_description'
        });
        
        var square = Math.min(widthPage, heightPage);
        var viewer = new ROS2D.Viewer({
          divID: 'nav',
          width: widthPage,
          height: heightPage,
          background: '#99FFCC'
        });

        // Setup the nav client.
        var nav = new NAV2D.OccupancyGridClientNav({
          ros: ros.ros,
          tfClient: ros.tfClient,
          continuous: true,
          robot_pose: '/base_link',
          rootObject: viewer.scene,
          withOrientation: true,
          viewer: viewer,
          //image: 'images/dude.png'
            //serverName: '/pr2_move_base'
        });

        $("#nav").css("width", widthPage - square / 2 - 16);
        $("#nav-menu").css("width", square / 2);

        // Load camera
        if('camera' in json.robot) {
            console.log("Load camera");
            camera = json.robot.camera;
            $("#threed-map").css("width", widthPage - square / 2 - 25);
            var camera_stream = new ROSCONSOLE.Camera({
                divID: "#camera_box",
                connection: connection,
                topic: camera.topic,
                size: square / 2 - 30,
            });
        }

        window.onresize = function(event) {
          var heightHeader = $(this).find('[data-role="header"]').height();
          var widthPage = $(window).width() - 16 * 2;
          var heightPage = $(window).height() - heightHeader - 16 * 2 - 110;
          square = Math.min(widthPage, heightPage);
          viewer.resize(widthPage, heightPage);
          viewer3D.resize(widthPage, heightPage);
          $("#nav").css("width", square / 2 - 16);
          $("#nav-menu").css("width", square / 2);
        };

        var map2DCont = new ROSCONSOLE.RadioController('#nav-controller', nav);
      };

      $.getJSON( "config.json" )
      .done(function( json ) {
        console.log( "JSON Data loaded!\nConnected to server " + json.server +":80");
        // Print configuration server
        console.log(json);
        // Load control
        runControl(json);
      })
      .fail(function( jqxhr, textStatus, error ) {
        var err = textStatus + ", " + error;
        console.log( "Request Failed: " + err );
        // Load control
        runControl();
      });
    });
  </script>
  <style>
    #threed-map canvas {
      border-radius: 14px;
      box-shadow: rgba(0, 0, 0, 0) 0px 0px 0px 0px, rgba(204, 204, 204, .5) 0px 1px 8px 0px, rgba(0, 0, 0, 0) 0px 0px 0px 0px, rgba(0, 0, 0, 0) 0px 0px 0px 0px;
    }

    .map2D canvas {
      border-radius: 14px;
      box-shadow: rgba(0, 0, 0, 0) 0px 0px 0px 0px, rgba(204, 204, 204, .5) 0px 1px 8px 0px, rgba(0, 0, 0, 0) 0px 0px 0px 0px, rgba(0, 0, 0, 0) 0px 0px 0px 0px;
    }

    .border canvas {
      border-radius: 14px;
      box-shadow: rgba(0, 0, 0, 0) 0px 0px 0px 0px, rgba(204, 204, 204, .5) 0px 1px 8px 0px, rgba(0, 0, 0, 0) 0px 0px 0px 0px, rgba(0, 0, 0, 0) 0px 0px 0px 0px;
    }
  </style>
</head>

<body>
  <!-- pages -->
  <!-- 3D map -->
  <div data-role="page" id="3Dmap" data-title="3D map" data-icon="navigation">
    <div data-role="content">
        <div class="ui-grid-a">
            <div id="threed-map" class="ui-block-a map3D"></div>
            <div id="camera_box"/>
        </div>
    </div>
  </div>
  <!-- 2D map -->
  <div data-role="page" id="2Dmap" data-title="2D map" data-icon="location">
    <div data-role="content">
            <div class="ui-grid-a">
                <div id="nav" class="ui-block-a map2D"></div>
                <div id="nav-menu" class="ui-block-b">
                    <h3 class="ui-bar ui-bar-a ui-corner-all">Map controller</h3>
                    <div class="ui-body ui-body-a ui-corner-all">
                      <form id="nav-controller">
                            <fieldset data-role="controlgroup">
                                <input type="radio" name="radio-choice-v-2" id="radio-map-zoom" value="on" checked="checked">
                                <label for="radio-map-zoom">Zoom</label>
                                <input type="radio" name="radio-choice-v-2" id="radio-map-goal" value="off">
                                <label for="radio-map-goal">Set goal</label>
                            </fieldset>
                        </form>
                        <div id="nav-button-controllers">

                        </div>
                    </div>
                </div>
            </div><!-- /grid-a -->
    </div>
  </div>
</body>

</html>
